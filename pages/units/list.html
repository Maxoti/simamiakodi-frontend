<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Units - SimamiaKodi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            background: #f8f9fa;
        }

        .page-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0 5px 0;
        }

        .stats-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .search-filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
        }

        .unit-card {
            background: white;
            border: 2px solid #e9ecef;
            border-left: 4px solid #0d6efd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .unit-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 5px 20px rgba(13, 110, 253, 0.15);
            transform: translateY(-2px);
        }

        .unit-card.occupied {
            border-left-color: #198754;
        }

        .unit-card.vacant {
            border-left-color: #ffc107;
        }

        .unit-number {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 5px;
        }

        .property-name {
            color: #0d6efd;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .unit-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-size: 14px;
        }

        .detail-item i {
            color: #0d6efd;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-vacant {
            background: #fff3cd;
            color: #856404;
        }

        .status-occupied {
            background: #d1e7dd;
            color: #0f5132;
        }

        .rent-amount {
            font-size: 20px;
            font-weight: 700;
            color: #198754;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-view {
            background: #e7f3ff;
            color: #0066cc;
        }

        .btn-view:hover {
            background: #0066cc;
            color: white;
        }

        .btn-edit {
            background: #fff4e5;
            color: #ff8c00;
        }

        .btn-edit:hover {
            background: #ff8c00;
            color: white;
        }

        .btn-delete {
            background: #ffe5e5;
            color: #dc3545;
        }

        .btn-delete:hover {
            background: #dc3545;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 80px;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .loading-spinner {
            text-align: center;
            padding: 60px;
        }

        .back-button {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        @media (max-width: 768px) {
            .unit-card {
                padding: 15px;
            }

            .unit-details {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-building me-2"></i>Units</h2>
                    <p class="mb-0 opacity-75">Manage your property units</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="../../dashboard.html" class="back-button">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                    <a href="add.html" class="btn btn-light">
                        <i class="fas fa-plus me-2"></i>Add Unit
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5">
        <!-- Stats Cards -->
        <div class="row mb-4" id="statsSection">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon" style="background: #e7f3ff; color: #0066cc;">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="stats-number" id="totalUnits">0</div>
                    <div class="stats-label">Total Units</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon" style="background: #d1e7dd; color: #198754;">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stats-number" id="occupiedUnits">0</div>
                    <div class="stats-label">Occupied Units</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon" style="background: #fff3cd; color: #856404;">
                        <i class="fas fa-door-closed"></i>
                    </div>
                    <div class="stats-number" id="vacantUnits">0</div>
                    <div class="stats-label">Vacant Units</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon" style="background: #cfe2ff; color: #084298;">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stats-number" id="occupancyRate">0%</div>
                    <div class="stats-label">Occupancy Rate</div>
                </div>
            </div>
        </div>

        <!-- Content Card -->
        <div class="content-card">
            <!-- Search and Filter Section -->
            <div class="search-filter-section">
                <div class="row g-3">
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search by unit number or type...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="propertyFilter">
                            <option value="">All Properties</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="vacant">Vacant</option>
                            <option value="occupied">Occupied</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" id="clearFilters">
                            <i class="fas fa-redo me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Info -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="text-muted" id="resultsInfo">Loading...</span>
                </div>
                <div>
                    <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                        <option value="unit_asc">Unit # (A-Z)</option>
                        <option value="unit_desc">Unit # (Z-A)</option>
                        <option value="rent_high">Rent (High-Low)</option>
                        <option value="rent_low">Rent (Low-High)</option>
                        <option value="status">Status</option>
                    </select>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-spinner">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading units...</p>
            </div>

            <!-- Units List -->
            <div id="unitsList"></div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h4>No Units Found</h4>
                <p class="text-muted">Start by adding your first unit or adjust your filters.</p>
                <a href="add.html" class="btn btn-primary-custom mt-3">
                    <i class="fas fa-plus me-2"></i>Add First Unit
                </a>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this unit?</p>
                    <p class="text-muted mb-0">
                        <strong id="deleteUnitName"></strong><br>
                        <small>This action cannot be undone.</small>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Delete Unit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../../js/auth.js"></script>
    <script>

        let allUnits = [];
        let filteredUnits = [];
        let properties = {};
        let deleteModal;
        let unitToDelete = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            loadProperties();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterUnits);
            document.getElementById('propertyFilter').addEventListener('change', filterUnits);
            document.getElementById('statusFilter').addEventListener('change', filterUnits);
            document.getElementById('sortSelect').addEventListener('change', sortAndDisplayUnits);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        }

        // Load properties for filter and mapping
        async function loadProperties() {
            try {
                const token = getAuthToken();
                
                const response = await fetch('http://localhost:5000/api/properties', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) return;

                const result = await response.json();
                const propertiesArray = result.data || [];

                // Create property lookup map
                propertiesArray.forEach(prop => {
                    properties[prop.property_id] = prop.property_name;
                });

                // Populate filter dropdown
                const select = document.getElementById('propertyFilter');
                propertiesArray.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.property_id;
                    option.textContent = property.property_name;
                    select.appendChild(option);
                });

                // After properties are loaded, load units
                loadUnits();
            } catch (error) {
                console.error('Error loading properties:', error);
                loadUnits(); // Load units anyway even if properties fail
            }
        }

        // Load units from API
        async function loadUnits() {
            try {
                const token = getAuthToken();
                
                const response = await fetch('http://localhost:5000/api/units', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load units');

                const result = await response.json();
                allUnits = result.data || [];
                
                // Add property names to units
                allUnits = allUnits.map(unit => ({
                    ...unit,
                    property_name: properties[unit.property_id] || 'Unknown Property'
                }));
                
                filteredUnits = [...allUnits];
                
                updateStats();
                sortAndDisplayUnits();
                
                document.getElementById('loadingState').style.display = 'none';
            } catch (error) {
                console.error('Error loading units:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load units. Please refresh the page.
                    </div>
                `;
            }
        }

        // Update statistics
        function updateStats() {
            const total = allUnits.length;
            const occupied = allUnits.filter(u => u.is_occupied).length;
            const vacant = total - occupied;
            const occupancyRate = total > 0 ? Math.round((occupied / total) * 100) : 0;

            document.getElementById('totalUnits').textContent = total;
            document.getElementById('occupiedUnits').textContent = occupied;
            document.getElementById('vacantUnits').textContent = vacant;
            document.getElementById('occupancyRate').textContent = occupancyRate + '%';
        }

        // Filter units
        function filterUnits() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const propertyId = document.getElementById('propertyFilter').value;
            const status = document.getElementById('statusFilter').value;

            filteredUnits = allUnits.filter(unit => {
                const matchesSearch = !searchTerm || 
                    unit.unit_number.toLowerCase().includes(searchTerm) ||
                    (unit.house_type && unit.house_type.toLowerCase().includes(searchTerm)) ||
                    (unit.property_name && unit.property_name.toLowerCase().includes(searchTerm));

                const matchesProperty = !propertyId || unit.property_id == propertyId;
                
                const matchesStatus = !status || 
                    (status === 'vacant' && !unit.is_occupied) ||
                    (status === 'occupied' && unit.is_occupied);

                return matchesSearch && matchesProperty && matchesStatus;
            });

            sortAndDisplayUnits();
        }

        // Sort and display units
        function sortAndDisplayUnits() {
            const sortBy = document.getElementById('sortSelect').value;

            filteredUnits.sort((a, b) => {
                switch(sortBy) {
                    case 'unit_asc':
                        return a.unit_number.localeCompare(b.unit_number);
                    case 'unit_desc':
                        return b.unit_number.localeCompare(a.unit_number);
                    case 'rent_high':
                        return (b.monthly_rent || 0) - (a.monthly_rent || 0);
                    case 'rent_low':
                        return (a.monthly_rent || 0) - (b.monthly_rent || 0);
                    case 'status':
                        return (a.is_occupied === b.is_occupied) ? 0 : a.is_occupied ? 1 : -1;
                    default:
                        return 0;
                }
            });

            displayUnits();
        }

        // Display units
        function displayUnits() {
            const container = document.getElementById('unitsList');
            const emptyState = document.getElementById('emptyState');

            document.getElementById('resultsInfo').textContent = 
                `Showing ${filteredUnits.length} of ${allUnits.length} units`;

            if (filteredUnits.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            container.innerHTML = filteredUnits.map(unit => {
                const statusClass = unit.is_occupied ? 'occupied' : 'vacant';
                const statusBadge = unit.is_occupied ? 
                    '<span class="status-badge status-occupied">Occupied</span>' : 
                    '<span class="status-badge status-vacant">Vacant</span>';

                return `
                    <div class="unit-card ${statusClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="unit-number">Unit ${unit.unit_number}</div>
                                <div class="property-name">
                                    <i class="fas fa-building"></i>
                                    ${unit.property_name}
                                </div>
                                
                                <div class="unit-details">
                                    <div class="detail-item">
                                        <i class="fas fa-home"></i>
                                        <span>${unit.house_type || 'N/A'}</span>
                                    </div>
                                    ${unit.bedrooms ? `
                                    <div class="detail-item">
                                        <i class="fas fa-bed"></i>
                                        <span>${unit.bedrooms} Bedrooms</span>
                                    </div>
                                    ` : ''}
                                    ${unit.bathrooms ? `
                                    <div class="detail-item">
                                        <i class="fas fa-bath"></i>
                                        <span>${unit.bathrooms} Bathrooms</span>
                                    </div>
                                    ` : ''}
                                    ${unit.square_meters ? `
                                    <div class="detail-item">
                                        <i class="fas fa-ruler-combined"></i>
                                        <span>${unit.square_meters} m²</span>
                                    </div>
                                    ` : ''}
                                    ${unit.has_parking ? `
                                    <div class="detail-item">
                                        <i class="fas fa-car"></i>
                                        <span>Parking</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="d-flex flex-column align-items-end gap-2">
                                ${statusBadge}
                                <div class="rent-amount">KES ${formatMoney(unit.monthly_rent)}</div>
                                <small class="text-muted">per month</small>
                                
                                <div class="action-buttons mt-2">
                                    <button class="btn-action btn-view" onclick="viewUnit(${unit.unit_id})" 
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-edit" onclick="editUnit(${unit.unit_id})" 
                                            title="Edit Unit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteUnit(${unit.unit_id}, '${unit.unit_number}')" 
                                            title="Delete Unit">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format money
        function formatMoney(amount) {
            if (!amount) return '0.00';
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('propertyFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortSelect').value = 'unit_asc';
            filterUnits();
        }

        // View unit details
        function viewUnit(id) {
            window.location.href = `details.html?id=${id}`;
        }

        // Edit unit
        function editUnit(id) {
            window.location.href = `edit.html?id=${id}`;
        }

        // Delete unit
        function deleteUnit(id, unitNumber) {
            unitToDelete = id;
            document.getElementById('deleteUnitName').textContent = `Unit ${unitNumber}`;
            deleteModal.show();
        }

        // Confirm delete
        async function confirmDelete() {
            if (!unitToDelete) return;

            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

            try {
                const token = getAuthToken();
                
                const response = await fetch(`http://localhost:5000/api/units/${unitToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    deleteModal.hide();
                    await loadUnits();
                    
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        ✅ Unit deleted successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
                    
                    setTimeout(() => alert.remove(), 3000);
                } else {
                    throw new Error('Failed to delete unit');
                }
            } catch (error) {
                console.error('Error deleting unit:', error);
                alert('Failed to delete unit. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                unitToDelete = null;
            }
        }
    </script>
</body>
</html>