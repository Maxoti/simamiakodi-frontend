<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Tenant - SimamiaKodi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            background: #f8f9fa;
        }

        .page-header {
            background: linear-gradient(135deg, #6f42c1 0%, #d63384 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 30px;
        }

        .section-title {
            color: #6f42c1;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #6f42c1;
            box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.15);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #6f42c1 0%, #d63384 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        }

        .btn-primary-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .back-button {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .alert {
            border-radius: 10px;
        }

        .unit-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .unit-info-item {
            margin-bottom: 8px;
        }

        .unit-info-label {
            font-weight: 600;
            color: #6c757d;
        }

        .unit-info-value {
            color: #212529;
        }

        .info-box {
            background: #f3eeff;
            border-left: 4px solid #6f42c1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
    <link rel="stylesheet" href="../../CSS/mobile-nav.css">
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-user-plus me-2"></i>Add New Tenant</h2>
                    <p class="mb-0 opacity-75">Register a new tenant in the system</p>
                </div>
                <div>
                    <a href="list.html" class="back-button">
                        <i class="fas fa-arrow-left me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <div class="container pb-5">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Info Box -->
        <div class="info-box">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Note:</strong> Fields marked with <span style="color: #dc3545;">*</span> are required.
        </div>

        <!-- Form Card -->
        <div class="form-card">
            <form id="add-tenant-form">
                <!-- Unit Assignment -->
                <h4 class="section-title">
                    <i class="fas fa-door-open"></i> Unit Assignment
                </h4>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label required-field">Property</label>
                        <select class="form-select" id="propertySelect" required>
                            <option value="">Select Property</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label required-field">Unit</label>
                        <select class="form-select" name="unit_id" id="unitSelect" required>
                            <option value="">Select Property First</option>
                        </select>
                    </div>
                </div>

                <!-- Unit Info Display -->
                <div class="unit-info" id="unitInfo" style="display: none;">
                    <h6 class="text-muted mb-3">Selected Unit Information:</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="unit-info-item">
                                <div class="unit-info-label">Unit Number</div>
                                <div class="unit-info-value" id="unitNumber">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="unit-info-item">
                                <div class="unit-info-label">House Type</div>
                                <div class="unit-info-value" id="unitType">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="unit-info-item">
                                <div class="unit-info-label">Bedrooms</div>
                                <div class="unit-info-value" id="unitBedrooms">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="unit-info-item">
                                <div class="unit-info-label">Monthly Rent</div>
                                <div class="unit-info-value" id="unitRent">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <h4 class="section-title mt-4">
                    <i class="fas fa-user"></i> Personal Information
                </h4>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label class="form-label required-field">Full Name</label>
                        <input type="text" class="form-control" name="full_name" 
                               placeholder="e.g., John Doe Mwangi" required>
                        <small class="text-muted">Enter the tenant's complete name</small>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label required-field">Email Address</label>
                        <input type="email" class="form-control" name="email" 
                               placeholder="tenant@example.com" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label required-field">Phone Number</label>
                        <input type="tel" class="form-control" name="phone" 
                               placeholder="+254712345678" required>
                    </div>
                </div>

                <!-- Move-in Information -->
                <h4 class="section-title mt-4">
                    <i class="fas fa-calendar-check"></i> Move-in Details
                </h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label required-field">Move-in Date</label>
                        <input type="date" class="form-control" name="move_in_date" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Move-out Date</label>
                        <input type="date" class="form-control" name="move_out_date">
                        <small class="text-muted">Leave empty if open-ended lease</small>
                    </div>
                </div>

                <!-- Financial Information -->
                <h4 class="section-title mt-4">
                    <i class="fas fa-money-bill-wave"></i> Financial Details
                </h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Deposit Paid (KES)</label>
                        <input type="number" class="form-control" name="deposit_paid" 
                               placeholder="0.00" step="0.01" min="0" value="0">
                        <small class="text-muted">Security deposit amount paid</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rent Balance (KES)</label>
                        <input type="number" class="form-control" name="rent_balance" 
                               placeholder="0.00" step="0.01" value="0">
                        <small class="text-muted">Outstanding rent amount (if any)</small>
                    </div>
                </div>

                <!-- Emergency Contact -->
                <h4 class="section-title mt-4">
                    <i class="fas fa-phone-alt"></i> Emergency Contact
                </h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Emergency Contact Name</label>
                        <input type="text" class="form-control" name="emergency_contact_name" 
                               placeholder="Full name">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Emergency Contact Phone</label>
                        <input type="tel" class="form-control" name="emergency_contact_phone" 
                               placeholder="+254712345678">
                    </div>
                </div>

                <!-- Status -->
                <h4 class="section-title mt-4">
                    <i class="fas fa-toggle-on"></i> Status
                </h4>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_active" 
                               id="isActiveCheck" checked style="width: 3em; height: 1.5em;">
                        <label class="form-check-label ms-2" for="isActiveCheck">
                            <strong>Active Tenant</strong>
                            <br><small class="text-muted">Tenant is currently active in the system</small>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='list.html'">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary-custom" id="submitBtn">
                        <i class="fas fa-save me-2"></i>Add Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>
<script src="../../js/config.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../../js/auth.js"></script>
   <script>
    // Authentication Functions
const API_URL = `${API_CONFIG.BASE_URL}/api`;

function protectPage() {
    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
    
    if (!token) {
        window.location.href = '/pages/auth/login.html';
        return false;
    }
    return true;
}

function getAuthToken() {
    return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
}

// Protect this page on load
if (!protectPage()) {
    throw new Error('Not authenticated');
}

let vacantUnits = [];

// Show alert function
function showAlert(message, type = 'danger') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProperties();
    loadVacantUnits();
    setupEventListeners();
    
    // Set today's date as default move-in date
    const today = new Date().toISOString().split('T')[0];
    const moveInDateInput = document.querySelector('input[name="move_in_date"]');
    if (moveInDateInput) {
        moveInDateInput.value = today;
    }
});

// Setup event listeners
function setupEventListeners() {
    const propertySelect = document.getElementById('propertySelect');
    const unitSelect = document.getElementById('unitSelect');
    
    if (propertySelect) {
        propertySelect.addEventListener('change', handlePropertyChange);
    }
    if (unitSelect) {
        unitSelect.addEventListener('change', handleUnitChange);
    }
}

// Load properties
async function loadProperties() {
    try {
        const token = getAuthToken();
        
        if (!token) {
            showAlert('Not authenticated. Please log in.', 'danger');
            setTimeout(() => window.location.href = '/pages/auth/login.html', 1500);
            return;
        }
        
        const response = await fetch(`${API_URL}/properties`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('Failed to load properties');

        const result = await response.json();
        const properties = result.data || [];

        const select = document.getElementById('propertySelect');
        
        if (properties.length === 0) {
            select.innerHTML = '<option value="">No properties available</option>';
            select.disabled = true;
            showAlert('⚠️ No properties found. Please add a property first.', 'warning');
            return;
        }

        select.innerHTML = '<option value="">Select Property</option>';
        properties.forEach(property => {
            const option = document.createElement('option');
            option.value = property.property_id;
            option.textContent = `${property.property_name} (${property.location || 'No location'})`;
            select.appendChild(option);
        });

        console.log(`Loaded ${properties.length} properties`);
    } catch (error) {
        console.error('Error loading properties:', error);
        showAlert('❌ Failed to load properties', 'danger');
    }
}

// Load vacant units only
async function loadVacantUnits() {
    try {
        const token = getAuthToken();
        
        const response = await fetch(`${API_URL}/units/vacant`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('Failed to load vacant units');

        const result = await response.json();
        vacantUnits = result.data || [];
        
        console.log(`Loaded ${vacantUnits.length} vacant units`);
    } catch (error) {
        console.error('Error loading vacant units:', error);
        showAlert('❌ Failed to load vacant units', 'danger');
    }
}

// Handle property selection change
function handlePropertyChange(e) {
    const propertyId = parseInt(e.target.value);
    const unitSelect = document.getElementById('unitSelect');
    const unitInfo = document.getElementById('unitInfo');
    
    // Clear unit selection
    unitSelect.innerHTML = '<option value="">Select Unit</option>';
    if (unitInfo) {
        unitInfo.style.display = 'none';
    }
    
    if (!propertyId) {
        unitSelect.disabled = true;
        return;
    }

    // Filter vacant units by selected property
    const availableUnits = vacantUnits.filter(unit => 
        unit.property_id === propertyId
    );

    if (availableUnits.length === 0) {
        unitSelect.innerHTML = '<option value="">No vacant units available</option>';
        unitSelect.disabled = true;
        showAlert('⚠️ All units in this property are currently occupied', 'warning');
        return;
    }

    // Populate unit dropdown
    unitSelect.disabled = false;
    availableUnits.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.unit_id;
        option.textContent = `${unit.unit_number} - ${unit.house_type || 'N/A'} - KES ${formatMoney(unit.monthly_rent)}`;
        option.dataset.unit = JSON.stringify(unit);
        unitSelect.appendChild(option);
    });

    console.log(`Found ${availableUnits.length} available units for this property`);
}

// Handle unit selection change
function handleUnitChange(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const unitInfo = document.getElementById('unitInfo');
    
    if (!selectedOption.dataset.unit) {
        if (unitInfo) {
            unitInfo.style.display = 'none';
        }
        return;
    }

    const unit = JSON.parse(selectedOption.dataset.unit);
    
    // Display unit info
    const unitNumber = document.getElementById('unitNumber');
    const unitType = document.getElementById('unitType');
    const unitBedrooms = document.getElementById('unitBedrooms');
    const unitRent = document.getElementById('unitRent');
    
    if (unitNumber) unitNumber.textContent = unit.unit_number;
    if (unitType) unitType.textContent = unit.house_type || 'N/A';
    if (unitBedrooms) unitBedrooms.textContent = unit.bedrooms || 'N/A';
    if (unitRent) unitRent.textContent = `KES ${formatMoney(unit.monthly_rent)}`;
    
    if (unitInfo) {
        unitInfo.style.display = 'block';
    }
}

// Format money
function formatMoney(amount) {
    if (!amount && amount !== 0) return '0.00';
    return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Handle form submission
document.getElementById('add-tenant-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
    
    try {
        const formData = new FormData(e.target);
        
        // Validate unit selection
        const unitId = parseInt(formData.get('unit_id'));
        if (!unitId) {
            throw new Error('Please select a unit');
        }
        
        const tenantData = {
            unit_id: unitId,
            full_name: formData.get('full_name')?.trim(),
            email: formData.get('email')?.trim(),
            phone: formData.get('phone')?.trim(),
            move_in_date: formData.get('move_in_date'),
            move_out_date: formData.get('move_out_date') || null,
            deposit_paid: formData.get('deposit_paid') ? parseFloat(formData.get('deposit_paid')) : 0,
            rent_balance: formData.get('rent_balance') ? parseFloat(formData.get('rent_balance')) : 0,
            emergency_contact_name: formData.get('emergency_contact_name')?.trim() || null,
            emergency_contact_phone: formData.get('emergency_contact_phone')?.trim() || null,
            is_active: formData.get('is_active') === 'on' || formData.get('is_active') === 'true'
        };
        
        // Validate required fields
        if (!tenantData.full_name) {
            throw new Error('Full name is required');
        }
        if (!tenantData.email) {
            throw new Error('Email is required');
        }
        if (!tenantData.phone) {
            throw new Error('Phone number is required');
        }
        if (!tenantData.move_in_date) {
            throw new Error('Move-in date is required');
        }
        
        console.log('Submitting Tenant Data:', tenantData);
        
        const token = getAuthToken();
        
        if (!token) {
            throw new Error('Not authenticated. Please log in.');
        }
        
        const response = await fetch(`${API_URL}/tenants`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(tenantData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('✅ Tenant added successfully!', 'success');
            
            // Clear form
            e.target.reset();
            
            setTimeout(() => {
                window.location.href = 'list.html';
            }, 1500);
        } else {
            throw new Error(result.error || result.message || 'Failed to add tenant');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('❌ Error: ' + error.message, 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
});
   </script>
</body>
</html>