<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Payment - SimamiaKodi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            background: #f8f9fa;
        }

        .page-header {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .back-button {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 30px;
        }

        .section-title {
            color: #198754;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title i {
            margin-right: 10px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.15);
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border: none;
            padding: 12px 40px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
        }

        .btn-secondary-custom {
            background: #6c757d;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-secondary-custom:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .quick-amount-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .quick-amount-btn {
            padding: 8px 20px;
            border: 2px solid #198754;
            background: white;
            color: #198754;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-amount-btn:hover {
            background: #198754;
            color: white;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box i {
            color: #0066cc;
            margin-right: 10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .tenant-info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .tenant-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .tenant-info-label {
            font-weight: 600;
            color: #6c757d;
        }

        .tenant-info-value {
            color: #212529;
        }

        @media (max-width: 768px) {
            .form-card {
                padding: 20px;
            }

            .quick-amount-buttons {
                gap: 5px;
            }

            .quick-amount-btn {
                padding: 6px 15px;
                font-size: 14px;
            }
        }
    </style>
    <link rel="stylesheet" href="../../CSS/mobile-nav.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-success spinner-border-custom" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 mb-0">Processing payment...</p>
        </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-plus-circle me-2"></i>Record New Payment</h2>
                    <p class="mb-0 opacity-75">Enter payment details to record a new transaction</p>
                </div>
                <a href="list.html" class="back-button">
                    <i class="fas fa-arrow-left me-2"></i>Back to Payments
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Info Box -->
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong>Quick Tip:</strong> All fields marked with <span class="text-danger">*</span> are required. 
                    Make sure to select the correct tenant and enter the payment amount.
                </div>

                <!-- Form Card -->
                <div class="form-card">
                    <form id="paymentForm">
                        <!-- Tenant Information Section -->
                        <div class="mb-4">
                            <h5 class="section-title">
                                <i class="fas fa-user"></i>
                                Tenant Information
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tenantSelect" class="form-label required-field">Select Tenant</label>
                                    <select class="form-select" id="tenantSelect" required>
                                        <option value="">-- Choose a tenant --</option>
                                    </select>
                                    <small class="text-muted">Select the tenant making this payment</small>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="propertySelect" class="form-label">Property</label>
                                    <select class="form-select" id="propertySelect" disabled>
                                        <option value="">-- Select tenant first --</option>
                                    </select>
                                    <small class="text-muted">Auto-filled from tenant selection</small>
                                </div>
                            </div>

                            <!-- Tenant Info Display -->
                            <div class="tenant-info-card" id="tenantInfoCard">
                                <div class="tenant-info-item">
                                    <span class="tenant-info-label">Unit:</span>
                                    <span class="tenant-info-value" id="displayUnit">-</span>
                                </div>
                                <div class="tenant-info-item">
                                    <span class="tenant-info-label">Monthly Rent:</span>
                                    <span class="tenant-info-value" id="displayRent">-</span>
                                </div>
                                <div class="tenant-info-item">
                                    <span class="tenant-info-label">Current Balance:</span>
                                    <span class="tenant-info-value" id="displayBalance">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details Section -->
                        <div class="mb-4">
                            <h5 class="section-title">
                                <i class="fas fa-money-bill-wave"></i>
                                Payment Details
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="amount" class="form-label required-field">Amount (KES)</label>
                                    <input type="number" class="form-control" id="amount" 
                                           placeholder="Enter amount" min="0" step="0.01" required>
                                    <div class="quick-amount-buttons">
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(5000)">5,000</button>
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(10000)">10,000</button>
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(15000)">15,000</button>
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(20000)">20,000</button>
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(25000)">25,000</button>
                                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount(30000)">30,000</button>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="paymentMethod" class="form-label required-field">Payment Method</label>
                                    <select class="form-select" id="paymentMethod" required>
                                        <option value="">-- Select method --</option>
                                        <option value="M-Pesa" selected>M-Pesa</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="paymentDate" class="form-label required-field">Payment Date</label>
                                    <input type="date" class="form-control" id="paymentDate" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="paymentMonth" class="form-label">Payment Month</label>
                                    <input type="month" class="form-control" id="paymentMonth">
                                    <small class="text-muted">Auto-filled from payment date</small>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction Details Section -->
                        <div class="mb-4">
                            <h5 class="section-title">
                                <i class="fas fa-file-invoice"></i>
                                Transaction Details
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3" id="mpesaCodeField">
                                    <label for="mpesaCode" class="form-label">M-Pesa Code</label>
                                    <input type="text" class="form-control" id="mpesaCode" 
                                           placeholder="e.g., ABC123XYZ4">
                                    <small class="text-muted">Transaction confirmation code</small>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="referenceNumber" class="form-label">Reference Number</label>
                                    <input type="text" class="form-control" id="referenceNumber" 
                                           placeholder="Optional reference">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" rows="3" 
                                          placeholder="Add any additional notes or comments..."></textarea>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 justify-content-end">
                            <button type="button" class="btn btn-secondary-custom" onclick="window.location.href='list.html'">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary-custom" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Record Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script src="../../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../js/auth.js"></script>

<script>
const API_URL = `${API_CONFIG.BASE_URL}/api`;

// Protect page using auth.js
if (!protectPage()) {
    console.log(' Access denied');
}

let tenants = [];
let properties = {};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    setDefaultDate();
    loadActiveTenants();
    setupEventListeners();
});

// Set default date to today
function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    const paymentDateInput = document.getElementById('paymentDate');
    if (paymentDateInput) {
        paymentDateInput.value = today;
        updatePaymentMonth();
    }
}

// Setup event listeners
function setupEventListeners() {
    const paymentDate = document.getElementById('paymentDate');
    const paymentMethod = document.getElementById('paymentMethod');
    const tenantSelect = document.getElementById('tenantSelect');
    const paymentForm = document.getElementById('paymentForm');
    
    if (paymentDate) paymentDate.addEventListener('change', updatePaymentMonth);
    if (paymentMethod) paymentMethod.addEventListener('change', toggleMpesaField);
    if (tenantSelect) tenantSelect.addEventListener('change', handleTenantChange);
    if (paymentForm) paymentForm.addEventListener('submit', handleSubmit);
}

// Load active tenants only
async function loadActiveTenants() {
    try {
        const token = getToken(); // ‚úÖ Use getToken() from auth.js
        
        if (!token) {
            showError('Not authenticated. Please log in.');
            setTimeout(() => location.href = '/pages/auth/login.html', 1500);
            return;
        }
        
        console.log('üîç Fetching tenants from:', `${API_URL}/tenants`);
        
        const response = await fetch(`${API_URL}/tenants`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('üì¶ Tenants response:', result);
        
        // Handle different response formats
        const allTenants = result.data || result.tenants || result;
        
        // Filter for active tenants only
        tenants = allTenants.filter(tenant => 
            tenant.is_active === true || tenant.is_active === 1 || tenant.status === 'active'
        );

        console.log('All tenants:', allTenants.length);
        console.log('Active tenants:', tenants.length);

        if (tenants.length === 0) {
            showError('‚ö†Ô∏è No active tenants found. Please add tenants first.');
            const tenantSelect = document.getElementById('tenantSelect');
            if (tenantSelect) {
                tenantSelect.innerHTML = '<option value="">No active tenants available</option>';
                tenantSelect.disabled = true;
            }
            return;
        }

        populateTenantSelect();
    } catch (error) {
        console.error('‚ùå Error loading tenants:', error);
        showError(`Failed to load tenants: ${error.message}`);
    }
}

// Populate tenant dropdown
function populateTenantSelect() {
    const select = document.getElementById('tenantSelect');
    
    if (!select) {
        console.error('‚ùå tenantSelect element not found!');
        return;
    }
    
    // Clear existing options
    select.innerHTML = '<option value="">-- Choose a tenant --</option>';
    
    tenants.forEach(tenant => {
        const option = document.createElement('option');
        option.value = tenant.tenant_id || tenant.id;
        
        const tenantName = tenant.full_name || tenant.name || `Tenant ${tenant.tenant_id}`;
        const unitNumber = tenant.unit_number || 'N/A';
        
        option.textContent = `${tenantName} - Unit ${unitNumber}`;
        option.dataset.tenant = JSON.stringify(tenant);
        select.appendChild(option);
    });

    console.log(`‚úÖ Populated ${tenants.length} active tenants in dropdown`);
}

// Handle tenant selection change
function handleTenantChange(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const tenantInfoCard = document.getElementById('tenantInfoCard');
    
    if (!selectedOption.dataset.tenant) {
        if (tenantInfoCard) tenantInfoCard.style.display = 'none';
        const propertySelect = document.getElementById('propertySelect');
        if (propertySelect) propertySelect.disabled = true;
        return;
    }

    const tenant = JSON.parse(selectedOption.dataset.tenant);
    console.log('üìã Selected tenant:', tenant);
    
    // Display tenant info
    const displayUnit = document.getElementById('displayUnit');
    const displayRent = document.getElementById('displayRent');
    const displayBalance = document.getElementById('displayBalance');
    
    if (displayUnit) displayUnit.textContent = tenant.unit_number || 'N/A';
    if (displayRent) displayRent.textContent = formatMoney(tenant.monthly_rent || 0);
    if (displayBalance) displayBalance.textContent = formatMoney(tenant.rent_balance || 0);
    if (tenantInfoCard) tenantInfoCard.style.display = 'block';

    // Set property
    const propertySelect = document.getElementById('propertySelect');
    if (propertySelect && tenant.property_name) {
        propertySelect.innerHTML = `<option value="${tenant.property_id || tenant.property_id}">${tenant.property_name}</option>`;
        propertySelect.disabled = false;
    }

    // Suggest amount if rent is available
    const amountInput = document.getElementById('amount');
    if (tenant.monthly_rent && amountInput && !amountInput.value) {
        amountInput.value = tenant.monthly_rent;
    }
}

// Update payment month based on payment date
function updatePaymentMonth() {
    const dateInput = document.getElementById('paymentDate');
    const monthInput = document.getElementById('paymentMonth');
    
    if (dateInput && monthInput && dateInput.value) {
        const month = dateInput.value.substring(0, 7);
        monthInput.value = month;
    }
}

// Toggle M-Pesa code field visibility
function toggleMpesaField() {
    const method = document.getElementById('paymentMethod')?.value || '';
    const mpesaField = document.getElementById('mpesaCodeField');
    
    if (!mpesaField) return;
    
    if (method.toLowerCase().includes('mpesa') || method.toLowerCase().includes('m-pesa')) {
        mpesaField.style.display = 'block';
    } else {
        mpesaField.style.display = 'none';
        const mpesaCode = document.getElementById('mpesaCode');
        if (mpesaCode) mpesaCode.value = '';
    }
}

// Set quick amount
function setQuickAmount(amount) {
    const amountInput = document.getElementById('amount');
    if (amountInput) amountInput.value = amount;
}

// Handle form submission
async function handleSubmit(e) {
    e.preventDefault();

    const tenantId = document.getElementById('tenantSelect')?.value;
    const amount = document.getElementById('amount')?.value;
    const paymentMethod = document.getElementById('paymentMethod')?.value;
    const paymentDate = document.getElementById('paymentDate')?.value;
    const paymentMonth = document.getElementById('paymentMonth')?.value;
    const mpesaCode = document.getElementById('mpesaCode')?.value || '';
    const referenceNumber = document.getElementById('referenceNumber')?.value || '';
    const notes = document.getElementById('notes')?.value || '';

    // Validate tenant selection
    if (!tenantId) {
        showError('Please select a tenant');
        return;
    }

    // Validate amount
    if (!amount || parseFloat(amount) <= 0) {
        showError('Please enter a valid payment amount');
        return;
    }

    // Get tenant details for property_id and unit_id
    const selectedTenant = tenants.find(t => (t.tenant_id || t.id) == tenantId);
    if (!selectedTenant) {
        showError('Please select a valid tenant');
        return;
    }

    // Show loading
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.style.display = 'flex';
    
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    const paymentData = {
        tenant_id: parseInt(tenantId),
        property_id: selectedTenant.property_id,
        unit_id: selectedTenant.unit_id,
        amount: parseFloat(amount),
        payment_date: paymentDate,
        payment_month: paymentMonth.substring(0, 7),
        payment_method: paymentMethod,
        mpesa_code: mpesaCode || null,
        reference_number: referenceNumber || null,
        notes: notes || null
    };

    console.log(' Submitting payment:', paymentData);

    try {
        const token = getToken(); // ‚úÖ Use getToken() from auth.js
        
        if (!token) {
            throw new Error('Not authenticated. Please log in.');
        }
        
        const response = await fetch(`${API_URL}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(paymentData)
        });

        const result = await response.json();

        if (response.ok) {
            showSuccess('‚úÖ Payment recorded successfully!');
            setTimeout(() => location.href = 'list.html', 1500);
        } else {
            throw new Error(result.error || result.message || 'Failed to record payment');
        }
    } catch (error) {
        console.error('‚ùå Error recording payment:', error);
        showError(error.message || 'Failed to record payment. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    } finally {
        if (loadingOverlay) loadingOverlay.style.display = 'none';
    }
}

// Format money
function formatMoney(amount) {
    if (!amount && amount !== 0) return 'KES 0.00';
    return 'KES ' + parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Show success message
function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '10000';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

// Show error message
function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '10000';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}
</script>
</body>
</html>
